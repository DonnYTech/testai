<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>欢迎页面</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-page: #f8fafc;
      --bg-card: #ffffff;
      --bg-input: #f1f5f9;
      --bg-message: #ffffff;
      --bg-message-user: #fefce8;
      --border: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      --gradient-primary: linear-gradient(135deg, #a855f7 0%, #ec4899 50%, #f97316 100%);
      --gradient-soft: linear-gradient(135deg, #c084fc 0%, #f0abfc 50%, #fb923c 100%);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      --shadow-elevated: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --danger: #ef4444;
      --danger-hover: #dc2626;
    }

    * { box-sizing: border-box; }

    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', 'Segoe UI', 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-card);
      max-width: 420px;
      width: 100%;
      padding: 36px 28px 32px;
      text-align: center;
      position: relative;
      animation: floatIn 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
    @keyframes floatIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .main-title {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
      margin: 0 0 6px;
    }
    .main-title .highlight {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0 0 28px;
      font-weight: 500;
    }
    .glow-btn {
      font-size: 0.95rem;
      font-weight: 600;
      padding: 12px 26px;
      color: #fff;
      background: var(--gradient-primary);
      border: none;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      outline: none;
    }
    .glow-btn:hover, .glow-btn:focus {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.35);
    }

    .message-section {
      margin-top: 28px;
      text-align: left;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }
    .message-section-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 14px;
      letter-spacing: 0.01em;
    }
    .message-input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      align-items: center;
    }
    .message-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .message-input::placeholder { color: var(--text-muted); }
    .message-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
    }
    .message-save-btn {
      padding: 12px 20px;
      border-radius: var(--radius);
      border: none;
      color: #fff;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      background: var(--gradient-primary);
      box-shadow: var(--shadow-sm);
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    }
    .message-save-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(168, 85, 247, 0.3);
    }
    .message-save-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .message-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .message-list::-webkit-scrollbar { width: 6px; }
    .message-list::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .message-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

    .message-item {
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: var(--bg-message);
      border-radius: var(--radius);
      padding: 14px 16px;
      padding-right: 56px;
      font-size: 0.9rem;
      color: var(--text-primary);
      line-height: 1.5;
      margin-bottom: 12px;
      text-align: left;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.04);
    }
    .message-item-avatar {
      flex-shrink: 0;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--bg-input);
      box-shadow: var(--shadow-sm);
    }
    .message-item-body { flex: 1; min-width: 0; }
    .message-item-nickname {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .message-item-content { min-width: 0; }
    .message-item-time {
      display: block;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 6px;
    }
    .message-delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      font-size: 0.7rem;
      color: #fff;
      background: var(--danger);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    .message-delete-btn:hover {
      background: var(--danger-hover);
      transform: scale(1.05);
    }
    .message-empty {
      font-size: 0.85rem;
      color: var(--text-muted);
      background: var(--bg-input);
      border: 1px dashed var(--border);
      box-shadow: none;
      padding: 16px;
    }
    .message-list-loading {
      list-style: none;
      padding: 28px 0;
      margin: 0;
      text-align: center;
      background: transparent;
      border: none;
    }
    .message-list-loading-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      animation: loadingPulse 1.2s ease-in-out infinite;
    }
    @keyframes loadingPulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 0.875rem;
      color: var(--text-primary);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-elevated);
      z-index: 9999;
      animation: toastIn 0.3s ease;
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="main-title">你好，<span class="highlight">世界</span>！</div>
    <div class="subtitle">这是我的第一个AI全栈项目</div>
    <button class="glow-btn" onclick="alert('恭喜你开启了编程之旅！')">
      开始你的旅程
    </button>
    <div class="message-section">
      <div class="message-section-title">留言板</div>
      <div class="message-input-row">
        <input
          id="message-input"
          class="message-input"
          type="text"
          placeholder="写点什么吧..."
        >
        <button id="save-message-btn" class="message-save-btn">
          保存留言
        </button>
      </div>
      <ul id="message-list" class="message-list">
        <li class="message-item message-empty">还没有留言，快来写第一条吧～</li>
      </ul>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // TODO: 将下面两个值替换成你在 Supabase 后台复制的 URL 和 anon key
    const SUPABASE_URL = 'https://raeaomvkgjjficvvoetj.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_lL3N4oaS81J6mvL2PWy5kg_EIOVIeIE';

    // 留言板需要 messages 表包含：id, content, created_at, nickname, avatar_url
    // 若表里还没有 nickname、avatar_url，请在 Supabase → SQL Editor 执行下方说明文件中的 SQL

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const messageInput = document.getElementById('message-input');
    const saveButton = document.getElementById('save-message-btn');
    const messageList = document.getElementById('message-list');
    const messageIds = new Set();

    /** 随机昵称池（发送留言时随机分配一个） */
    const NICKNAMES = [
      '可爱的火星人', '勇敢的小仓鼠', '快乐的小企鹅', '爱笑的向日葵', '爱做梦的星星',
      '温柔的小鹿', '好奇的探险家', '爱读书的猫头鹰', '会唱歌的云朵', '爱跑步的兔子',
      '安静的小蘑菇', '热情的小太阳', '爱画画的彩虹', '爱旅行的风', '爱睡觉的考拉',
      '机灵的小狐狸', '憨厚的大熊猫', '爱跳舞的蝴蝶', '爱游泳的海豚', '爱思考的猫'
    ];

    /** 根据昵称生成 DiceBear 卡通头像 URL（免费 API，无需注册） */
    function getDiceBearUrl(seed) {
      const s = (seed || 'guest').toString().trim() || 'guest';
      return 'https://api.dicebear.com/9.x/lorelei/svg?seed=' + encodeURIComponent(s);
    }

    function getRandomNickname() {
      return NICKNAMES[Math.floor(Math.random() * NICKNAMES.length)];
    }

    /** 将 Supabase created_at (ISO) 转为易读时间，如 2026-01-30 20:00 */
    function formatTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const hh = String(date.getHours()).padStart(2, '0');
      const mm = String(date.getMinutes()).padStart(2, '0');
      return y + '-' + m + '-' + d + ' ' + hh + ':' + mm;
    }

    function createMessageLi(msg) {
      const li = document.createElement('li');
      li.className = 'message-item';
      if (msg.id) {
        li.dataset.id = msg.id;
        messageIds.add(msg.id);
      }
      const avatarUrl = msg.avatar_url || getDiceBearUrl(msg.nickname || msg.id || 'guest');
      const nickname = msg.nickname || '神秘访客';

      const img = document.createElement('img');
      img.className = 'message-item-avatar';
      img.src = avatarUrl;
      img.alt = nickname;
      img.loading = 'lazy';
      li.appendChild(img);

      const body = document.createElement('div');
      body.className = 'message-item-body';
      const nameEl = document.createElement('div');
      nameEl.className = 'message-item-nickname';
      nameEl.textContent = nickname;
      body.appendChild(nameEl);
      const contentWrap = document.createElement('div');
      contentWrap.className = 'message-item-content';
      contentWrap.textContent = msg.content || '';
      const timeSpan = document.createElement('span');
      timeSpan.className = 'message-item-time';
      timeSpan.textContent = formatTime(msg.created_at);
      contentWrap.appendChild(timeSpan);
      body.appendChild(contentWrap);
      li.appendChild(body);

      const delBtn = document.createElement('button');
      delBtn.className = 'message-delete-btn';
      delBtn.type = 'button';
      delBtn.textContent = '删除';
      li.appendChild(delBtn);
      return li;
    }

    function renderMessages(messages) {
      messageList.innerHTML = '';
      messageIds.clear();
      if (!messages || messages.length === 0) {
        const li = document.createElement('li');
        li.className = 'message-item message-empty';
        li.textContent = '还没有留言，快来写第一条吧～';
        messageList.appendChild(li);
        return;
      }

      messages.forEach(msg => {
        messageList.appendChild(createMessageLi(msg));
      });
    }

    function showToast(text) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = text;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2000);
    }

    async function deleteMessage(id) {
      const { error } = await supabaseClient
        .from('messages')
        .delete()
        .eq('id', id);
      if (error) {
        console.error('删除留言失败：', error.message);
        alert('删除失败，请稍后再试。');
        return;
      }
      const li = messageList.querySelector('[data-id="' + id + '"]');
      if (li) {
        li.remove();
        messageIds.delete(id);
      }
      showToast('已删除');
    }

    function showListLoading() {
      messageList.innerHTML = '<li class="message-list-loading"><span class="message-list-loading-text">正在翻阅留言本...</span></li>';
    }

    async function loadMessages() {
      showListLoading();
      const { data, error } = await supabaseClient
        .from('messages')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(50);

      if (error) {
        console.error('加载留言失败：', error.message);
        messageList.innerHTML = '<li class="message-item message-empty">加载失败，请刷新重试</li>';
        return;
      }

      renderMessages(data);
    }

    async function saveMessage() {
      const content = (messageInput.value || '').trim();
      if (!content) {
        alert('请输入留言内容~');
        return;
      }

      saveButton.disabled = true;

      const nickname = getRandomNickname();
      const avatar_url = getDiceBearUrl(nickname);

      const { error } = await supabaseClient
        .from('messages')
        .insert({ content, nickname, avatar_url });

      if (error) {
        console.error('保存留言失败：', error.message);
        alert('保存失败，请稍后再试。');
      } else {
        console.log('保存留言成功');
        alert('留言已保存成功！');
        messageInput.value = '';
        loadMessages();
      }

      saveButton.disabled = false;
    }

    saveButton.addEventListener('click', saveMessage);
    messageInput.addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        saveMessage();
      }
    });

    messageList.addEventListener('click', function (event) {
      const btn = event.target.closest('.message-delete-btn');
      if (!btn) return;
      const li = btn.closest('.message-item');
      if (!li || !li.dataset.id) return;
      deleteMessage(li.dataset.id);
    });

    // 初始加载历史留言
    loadMessages();

    // 订阅实时插入的留言
    const channel = supabaseClient
      .channel('public:messages')
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'messages' },
        payload => {
          // 将新留言插入列表顶部
          const newMsg = payload.new;

          // 如果这条留言已经在列表中了（例如刚刚 loadMessages 刷新过），就不再重复插入
          if (newMsg.id && messageIds.has(newMsg.id)) {
            return;
          }
          if (newMsg.id) {
            messageIds.add(newMsg.id);
          }

          // 如果当前还是“暂无留言”的提示，先清空
          const first = messageList.firstElementChild;
          if (first && first.classList.contains('message-empty')) {
            messageList.innerHTML = '';
          }

          const li = createMessageLi(newMsg);
          messageList.insertBefore(li, messageList.firstChild);
        }
      )
      .subscribe(status => {
        if (status === 'SUBSCRIBED') {
          console.log('已订阅 messages 表的实时更新');
        }
      });
  </script>
</body>
</html>